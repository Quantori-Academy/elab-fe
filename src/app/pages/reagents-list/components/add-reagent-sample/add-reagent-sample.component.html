@if (dataSource.data) {
<div class="wrapper">
  <div class="control-bar-wrapper">
    <div class="filter-container">
      <mat-form-field appearance="fill" subscriptSizing="dynamic">
        <mat-label>Search by name</mat-label>
        <input
          matInput
          (input)="onFilterName($event)"
          placeholder="Enter a name"
        />
      </mat-form-field>

      <mat-form-field appearance="fill" subscriptSizing="dynamic">
        <mat-label>Filter by Category</mat-label>
        <mat-select (selectionChange)="onFilterCategory($event.value)">
          <mat-option value="">All Categories</mat-option>
          <mat-option value="Sample">Sample</mat-option>
          <mat-option value="Reagent">Reagent</mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <button mat-flat-button type="button" (click)="onSave()">Save</button>
  </div>
  <div class="mat-elevation-z8 table-container">
    <div class="table-content">
      <form [formGroup]="formSelection">
        <ng-container formArrayName="reagents">
          <table
            mat-table
            [dataSource]="dataSource"
            matSort
            (matSortChange)="onSortChange($event)"
          >
            <!-- Name Column -->
            <ng-container matColumnDef="name" class="name-column">
              <th
                mat-header-cell
                *matHeaderCellDef
                mat-sort-header
                class="name-column"
              >
                Name
              </th>
              <td mat-cell *matCellDef="let element" class="name-column">
                {{ element.name }}
              </td>
            </ng-container>
            <ng-container matColumnDef="category">
              <th mat-header-cell *matHeaderCellDef>Category</th>
              <td mat-cell *matCellDef="let element">{{ element.category }}</td>
            </ng-container>
            <!-- Structure Column -->
            <ng-container matColumnDef="structure">
              <th mat-header-cell *matHeaderCellDef>Structure</th>
              <td mat-cell *matCellDef="let element">
                <app-molecule-structure
                  [structure]="element.structure"
                  [width]="100"
                  [height]="100"
                />
              </td>
            </ng-container>

            <!-- Quantity Column -->
            <ng-container matColumnDef="quantity">
              <th mat-header-cell *matHeaderCellDef>Quantity</th>
              <td mat-cell *matCellDef="let element">
                {{ element.totalQuantity }} {{ element.quantityUnit }}
              </td>
            </ng-container>

            <!-- QuantityLeft Column -->
            <ng-container matColumnDef="quantityLeft">
              <th mat-header-cell *matHeaderCellDef>Quantity Left</th>
              <td mat-cell *matCellDef="let element">
                {{ element.quantityLeft }} {{ element.quantityUnit }}
              </td>
            </ng-container>

            <!-- Select Column -->
            <ng-container matColumnDef="isSelect">
              <th mat-header-cell *matHeaderCellDef>Select</th>
              <td
                mat-cell
                *matCellDef="let element; let i = index"
                [formGroupName]="i"
              >
                <mat-checkbox
                  formControlName="isSelect"
                  [checked]="element.isSelected"
                />
              </td>
            </ng-container>

            <!-- Select Quantity Column -->
            <ng-container matColumnDef="selectQuantity">
              <th mat-header-cell *matHeaderCellDef>Select Quantity</th>
              <td
                mat-cell
                *matCellDef="let element; let i = index"
                [formGroupName]="i"
              >
                <mat-form-field appearance="fill" class="select-quantity-input">
                  <input
                    formControlName="quantityUsed"
                    type="number"
                    matInput
                    placeholder="0"
                    min="0"
                    max="{{ element.quantityLeft }}"
                    step="0.01"
                    [value]="element.quantityUsed"
                    (wheel)="$event.preventDefault()"
                  />
                  <span matTextSuffix style="text-wrap: nowrap">
                    / {{ element.quantityLeft }}
                    {{ element.quantityUnit }}</span
                  >
                  @if(hasError(i,'quantityUsed', 'max')) {
                  <mat-error
                    >Quantity should less than {{ element.quantityLeft }}
                    {{ element.quantityUnit }}</mat-error
                  >
                  } @if(hasError(i,'quantityUsed', 'min')) {
                  <mat-error>Quantity should more than 0</mat-error>
                  } @if(hasError(i,'quantityUsed', 'required')) {
                  <mat-error>Quantity is required</mat-error>
                  } @if (hasError(i, 'quantityUsed', 'serverError')) {
                  <mat-error>
                    {{
                      reagentsFormArray
                        .at(i)
                        .get("quantityUsed")
                        ?.getError("serverError")
                    }}
                  </mat-error>
                  }
                </mat-form-field>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>
        </ng-container>
      </form>
    </div>

    <!-- we can remove pagination if it's unnecessary -->
    <mat-paginator
      #paginator
      class="demo-paginator"
      (page)="handlePageEvent($event)"
      [length]="reagentsSize"
      [pageSize]="pageSize"
      [pageIndex]="currentPage"
      [pageSizeOptions]="pageSizeOptions"
      aria-label="Select page"
    ></mat-paginator>
  </div>
</div>
} @else {
<app-table-loader-spinner />
}
